{% extends "base.html" %}
{% block title %}Seznam članov – {{ request.state.klub_oznaka or 'Radio klub' }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-people-fill me-2 text-primary"></i>Seznam članov</h4>
  {% if is_editor %}
  <a href="/clani/nov" class="btn btn-success btn-sm">
    <i class="bi bi-person-plus-fill me-1"></i>Dodaj člana
  </a>
  {% endif %}
</div>

<!-- Filtri -->
<div class="card mb-3">
  <div class="card-body py-2">
    <form method="get" action="/clani" class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label small mb-1">Iskanje</label>
        <input type="text" name="q" class="form-control form-control-sm" placeholder="Ime, priimek ali klicni znak..." value="{{ q }}">
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">Tip članstva</label>
        <select name="tip" class="form-select form-select-sm">
          <option value="">Vsi tipi</option>
          {% for t in tipi_clanstva %}
          <option value="{{ t }}" {% if tip == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">Status</label>
        <select name="aktiven" class="form-select form-select-sm">
          <option value="da" {% if aktiven == 'da' %}selected{% endif %}>Aktivni</option>
          <option value="ne" {% if aktiven == 'ne' %}selected{% endif %}>Neaktivni</option>
          <option value="" {% if aktiven == '' %}selected{% endif %}>Vsi</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">Leto čl.</label>
        <select name="leto_placila" class="form-select form-select-sm" onchange="this.form.submit()">
          {% for y in range(leto_zdaj, 2016, -1) %}
          <option value="{{ y }}" {% if leto == y %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">Stanje čl.</label>
        <select name="placal" class="form-select form-select-sm">
          <option value="" {% if placal == '' %}selected{% endif %}>Vsi</option>
          <option value="da" {% if placal == 'da' %}selected{% endif %}>Plačano</option>
          <option value="ne" {% if placal == 'ne' %}selected{% endif %}>Neplačano</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">Veljavnost RD</label>
        <select name="rd" class="form-select form-select-sm">
          <option value="" {% if rd == '' %}selected{% endif %}>Vse</option>
          <option value="veljavna" {% if rd == 'veljavna' %}selected{% endif %}>✅ Veljavna</option>
          <option value="kmalu" {% if rd == 'kmalu' %}selected{% endif %}>⚠️ Poteče v 6 mes.</option>
          <option value="potekla" {% if rd == 'potekla' %}selected{% endif %}>❌ Potekla</option>
          <option value="brez" {% if rd == 'brez' %}selected{% endif %}>— Brez RD</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary btn-sm w-100">
          <i class="bi bi-search me-1"></i>Filtriraj
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Tabela -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table id="tabela-clanov" class="table table-hover table-striped mb-0 align-middle">
        <thead class="table-primary">
          <tr>
            <th>Priimek in ime</th>
            <th>Klicni znak</th>
            <th>Tip članstva</th>
            <th>Razred</th>
            <th>Veljavnost RD</th>
            <th class="text-center">Članarina {{ leto }}</th>
            <th class="text-center">Akcije</th>
          </tr>
        </thead>
        <tbody>
          {% for clan in clani %}
          <tr>
            <td>
              <a href="/clani/{{ clan.id }}" class="text-decoration-none fw-semibold">
                {{ clan.priimek }} {{ clan.ime }}
              </a>
              {% if not clan.aktiven %}<span class="badge bg-secondary ms-1">neaktiven</span>{% endif %}
            </td>
            <td>
              {% if clan.klicni_znak %}
              <code class="fs-6">{{ clan.klicni_znak }}</code>
              {% else %}
              <span class="text-muted">–</span>
              {% endif %}
            </td>
            <td>
              <span class="badge
                {% if clan.tip_clanstva == 'Redno' %}bg-primary
                {% elif clan.tip_clanstva == 'Družinsko' %}bg-info text-dark
                {% elif clan.tip_clanstva == 'Simpatizerji' %}bg-secondary
                {% elif clan.tip_clanstva == 'Mladi/dijaki/študenti' %}bg-success
                {% elif clan.tip_clanstva == 'Invalidi' %}bg-warning text-dark
                {% else %}bg-light text-dark{% endif %}">
                {{ clan.tip_clanstva }}
              </span>
            </td>
            <td>{{ clan.operaterski_razred or '–' }}</td>
            <td>
              {% if clan.veljavnost_rd %}
                {% if clan.veljavnost_rd < danes %}
                  <span class="text-danger" title="Potekla {{ clan.veljavnost_rd.strftime('%d.%m.%Y') }}">
                    <i class="bi bi-x-circle-fill me-1"></i>{{ clan.veljavnost_rd.strftime('%d.%m.%Y') }}
                  </span>
                {% elif clan.veljavnost_rd <= kmalu_meja %}
                  <span class="text-warning" title="Poteče kmalu">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ clan.veljavnost_rd.strftime('%d.%m.%Y') }}
                  </span>
                {% else %}
                  <span class="text-success">
                    <i class="bi bi-check-circle me-1"></i>{{ clan.veljavnost_rd.strftime('%d.%m.%Y') }}
                  </span>
                {% endif %}
              {% else %}
                <span class="text-muted">–</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if clan.id in placali_ids %}
              <i class="bi bi-check-circle-fill text-success fs-5" title="Plačano"></i>
              {% else %}
              <i class="bi bi-x-circle text-danger fs-5" title="Neplačano"></i>
              {% endif %}
            </td>
            <td class="text-center">
              <a href="/clani/{{ clan.id }}" class="btn btn-outline-primary btn-sm" title="Podrobnosti">
                <i class="bi bi-eye"></i>
              </a>
              {% if is_editor %}
              <a href="/clani/{{ clan.id }}/uredi" class="btn btn-outline-secondary btn-sm" title="Uredi">
                <i class="bi bi-pencil"></i>
              </a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer text-muted small">
    Skupaj: <strong>{{ clani|length }}</strong> članov
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
  $('#tabela-clanov').DataTable({
    responsive: true,
    language: {
      url: 'https://cdn.datatables.net/plug-ins/2.1.8/i18n/sl.json',
      emptyTable: 'Ni rezultatov'
    },
    pageLength: 25,
    order: [[0, 'asc']],
    columnDefs: [
      { orderable: false, targets: [5, 6] },
      { responsivePriority: 1, targets: 0 },
      { responsivePriority: 2, targets: 6 },
      { responsivePriority: 3, targets: 1 },
      { responsivePriority: 4, targets: 2 },
      { responsivePriority: 5, targets: 5 },
      { responsivePriority: 6, targets: 4 },
      { responsivePriority: 7, targets: 3 },
    ],
  });
});
</script>
{% endblock %}
